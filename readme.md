通用测控上位机
======
# 功能  
嵌入式设备开发调试过程中，需要使用上位机查看设备状态，下达指令。使用曲线实现状态可视化，记录数据事后分析等功能能够大大提高开发调试效率。  
而不同的嵌入式设备，不同的项目，需要上位机控制的量完全不同，导致基本上每块电路都需要自己的上位机，这个工作量是难以承担的。  
所以需要一款通用上位机，能够尽可能广泛的适应各种项目，各种设备的调试工作。  
通过文本行方式对设备进行测控，包括状态上报和指令下达。状态变量和指令都通过配置文件描述，所以上位机可以在各项目间通用。  
上位机实现曲线显示、变量显示、变量有效性显示、指令下达、数据记录等功能  
## 测控设计原则  
基本仪表测控分为状态上报(上行)和指令下达(下行)两部分,数据类型包括：  
1. 块数据：一段非数值数据，例如地图  
	若需要分包发送，则需要包序号和校验保证完整性。若信道指令不好，还需进行确认反馈  
2. 数值型数据  
	包括数字、字符串，一般多个数值型数据打包发送，当带宽足够时，也可单独发送  
3. 开关量数据  
	一般使用位段压缩在几个字节以内，作为一个数值型变量发送  
4. 事件
	一般通过独立包发送，触发发送。  
对于下行指令，在一个数据组织(数据包)中的不同变量都作为指令执行，除非单主机完全控制，否则影响指令的灵活性，例如，一次操作仅希望影响一个变量，则数据包中的其他变量也都不可避免的被修改了。  
对于具有多个控制端，或一些控制变量涉及自动/人工切换时，需要单独控制的下行指令，需要分小包下发，每个包仅容纳一个控制变量。对于开关型数据，可采用mask方式指定一组有效的变量。  
## 测控UI的基本需求  
1. 非控数值型：名称、显示label、刷新标志、记录/曲线标志  
2. 测控数值型：名称、显示label、刷新标志、记录/曲线标志、输入框  
3. 非控开关型：名称、刷新标志  
4. 测控开关型：名称、刷新标志、期望状态  
# 协议  
## 通用数据协议  
使用类nmea协议的形式，作为上位机的标准协议，其他协议使用适配器来适配，例如，下位机使用二进制协议时，上位机通过适配器将文本协议转换为二进制协议与下位机交互。  
所以对于上位机来说，协议为类nmea的文本协议，用于对测量变量、指令按钮进行配置  
协议规定，使用行（\n）作为数据包的分割，对于指令，使用空格或tab作为参数的分割符。对于测量变量，使用空格、逗号、tab作为分隔符，行首第一列可以作为普通数据，也可作为协议标志，以$开头，接协议名称。  
规定：  
指令配置时，可通过写入\n来做多个指令
$开头的是与插件或下位机约定的文本协议  
^开头的是软件自身控制协议：  
	^clear         清除当前数据  
	^x_axis 总电压 x轴的索引，只有收到此变量后才增加曲线x轴坐标，若为空，则使用时间ms数作为x轴  
## 测量变量配置协议  
变量名称要求没有空格  
## 指令配置协议  
指令名称要求没有空格  
# 结构  
上位机由C# wpf开发，C#部分使用通用文本测控协议，对状态变量和指令进行描述和交互；使用协议适配器对设备实际协议进行适配。协议适配器为动态库，以cdecl方式调用。  
上位机加载适配器后，将串口数据以流的方式发送给适配器，适配器通过返回标志指示是否提取到了有效数据包，通过全局变量传递结果字符，以通用文本测控协议实现交互。  
